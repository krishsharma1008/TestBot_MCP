================================================================================
TESTBOT MCP DEVELOPMENT DOCUMENTATION
================================================================================

================================================================================
Update: 2026-01-28 - OpenAI Test Generation Feature
================================================================================

SUMMARY:
--------
Implemented AI-powered automatic test generation using OpenAI GPT when TestBot
detects no existing E2E tests in a project. This enhancement transforms TestBot
from a test runner into a complete testing solution.

NEW FEATURES:
-------------
1. OpenAI Test Generation
   - Automatically generates Playwright tests when no tests exist
   - Uses GPT-4o (configurable) for intelligent test creation
   - Generates smoke, frontend, backend, and workflow tests
   - Supports Product Requirements Document (PRD) input for better tests

2. Browser Configuration UI
   - Launches a web form when no tests exist
   - Collects PRD, test preferences, and project settings
   - Modern UI matching the dashboard aesthetic
   - Auto-saves form data to prevent loss

3. Enhanced Context Gathering
   - Extracts richer codebase details (file contents, component structure)
   - Parses API schemas (Zod, Yup validation)
   - Identifies form fields and validation rules
   - Detects authentication patterns (NextAuth, JWT, OAuth, etc.)

4. Agent Context Requester
   - Generates prompts for Cursor/Windsurf agents to analyze codebase
   - Merges auto-gathered context with agent insights
   - Provides richer context for OpenAI test generation

FILES CREATED:
--------------
1. testbot-mcp/src/ai-providers/openai.js
   - OpenAI client following existing provider pattern
   - Supports both test generation and failure analysis
   - Handles API errors gracefully with clear messages

2. testbot-mcp/src/config-ui-launcher.js
   - Launches browser-based configuration form
   - Creates local HTTP server to handle form submission
   - Returns collected configuration to MCP

3. testbot-mcp/src/agent-context-requester.js
   - Generates detailed prompts for AI agent analysis
   - Waits for agent response with timeout
   - Merges contexts from multiple sources

4. testbot-mcp/src/test-generator-openai.js
   - Orchestrates intelligent test generation
   - Implements prompt engineering for Playwright tests
   - Handles chunked generation by test type
   - Writes test files with proper imports

5. dashboard/public/config-form.html
   - Multi-step configuration wizard
   - PRD input with markdown preview
   - Test type and coverage options

6. dashboard/public/config-form.css
   - Styles matching dashboard aesthetic
   - Responsive design
   - Progress steps indicator

7. dashboard/public/config-form.js
   - Form handling and validation
   - LocalStorage auto-save
   - Template loading for quick PRD setup

FILES MODIFIED:
---------------
1. testbot-mcp/src/index.js
   - Added OpenAI test generation flow
   - Integrated config UI launcher
   - Added agent context requester
   - Updated tool schema with openai provider

2. testbot-mcp/src/context-gatherer.js
   - Enhanced with gatherRichContext() method
   - Added form detection and validation parsing
   - Added data model extraction (TypeScript, Prisma)
   - Added authentication pattern detection
   - Enhanced workflow inference

3. testbot-mcp/src/ai-providers/index.js
   - Added OpenAI to provider factory
   - Added createOpenAI() helper method
   - Added hasOpenAIKey() check method

4. testbot-mcp/package.json
   - Updated version to 1.1.0
   - Added openai as optional dependency

5. .env.example
   - Added OpenAI configuration section
   - Added OPENAI_API_KEY, OPENAI_MODEL, OPENAI_MAX_TOKENS

6. .env
   - Added OPENAI_API_KEY with user's key
   - Set AI_PROVIDER to openai

CONFIGURATION:
--------------
Add to .env:
  OPENAI_API_KEY=sk-proj-...
  OPENAI_MODEL=gpt-4o (optional, defaults to gpt-4o)
  OPENAI_MAX_TOKENS=4000 (optional)

USAGE FLOW:
-----------
1. User runs "test my app using testbot mcp" on a project with no tests
2. TestBot detects no existing tests
3. Checks for OPENAI_API_KEY (fails clearly if missing)
4. Gathers rich codebase context automatically
5. Launches config UI in browser (if no PRD provided)
6. User fills out PRD and test preferences
7. TestBot calls OpenAI to generate tests
8. Tests are written to tests/generated/
9. Playwright runs the generated tests
10. Dashboard displays results with AI analysis

ERROR HANDLING:
---------------
- Missing API key: Clear error message with setup instructions
- Generation failures: Logs full error, preserves partial results
- Config UI timeout: Falls back to template-based generation
- OpenAI API errors: Retries with exponential backoff

TESTING:
--------
To verify the implementation:
1. Go to a project without tests
2. Ensure OPENAI_API_KEY is set in .env
3. Run testbot_test_my_app via MCP
4. Observe test generation and execution

================================================================================

================================================================================
Update: 2026-01-28 (Later) - Dashboard Refresh and Caching Fixes
================================================================================

SUMMARY:
--------
Fixed dashboard refresh issues and clarified config UI behavior.

ISSUES IDENTIFIED:
------------------
1. Browser Caching
   - Browser caches dashboard HTML/CSS/JS files
   - Old data persists even when report.json is updated

2. Config UI Behavior
   - Config UI ONLY shows when NO tests exist
   - User's project had tests in tests/generated/
   - This is by design, not a bug

3. Playwright MCP Integration
   - TestBot MCP and Playwright MCP are separate
   - TestBot uses Playwright directly (npm package)

FIXES APPLIED:
--------------
1. Enhanced Dashboard Cache Busting
   - Added cache-control meta tags to index.html
   - Versioned CSS/JS references
   - Added auto-reload notification
   - Improved dashboard-launcher.js

2. Created Tools
   - refresh-dashboard.sh for manual refresh
   - DASHBOARD_REFRESH_GUIDE.md with complete docs

WHEN CONFIG UI SHOWS:
---------------------
Conditions (ALL must be true):
1. Project has NO existing test files
2. OPENAI_API_KEY is set in .env
3. generateTests parameter is true

To Force: Delete tests/generated/ directory

HOW TO REFRESH DASHBOARD:
-------------------------
1. Press Cmd+Shift+R (Mac) or Ctrl+Shift+R (Windows)
2. Run ./refresh-dashboard.sh
3. Close browser completely and rerun TestBot

CURRENT STATUS:
---------------
✅ All modules loading correctly
✅ OpenAI integration implemented
✅ Dashboard refresh mechanism improved
✅ Documentation created (DASHBOARD_REFRESH_GUIDE.md)
⚠️  Config UI only triggers when no tests exist (by design)

================================================================================
Update: 2026-01-28 16:55 - Dashboard Refresh Debug & Fix Implementation
================================================================================

SUMMARY:
--------
Fixed the root cause of dashboard not updating after test runs. The issue was
that Playwright's JSON reporter was not configured to output to a file,
causing TestBot to receive 0 tests.

ROOT CAUSE IDENTIFIED:
----------------------
The Playwright configuration had:
  reporter: 'json'

This outputs JSON to stdout only. TestBot was looking for test-results.json
file which didn't exist, causing parseTestResults() to return 0 tests.

FIX APPLIED:
------------
Changed to:
  reporter: [['json', { outputFile: 'test-results.json' }]]

This creates the test-results.json file that TestBot can read.

FILES MODIFIED:
---------------
1. examples/sample-project/playwright.config.js
   - Changed reporter config to output to file
   
2. testbot-mcp/src/playwright-integration.js
   - Added comprehensive logging to parseTestResults()
   - Added warnings when test-results.json is missing
   - Added diagnostic hints in error messages
   - Improved extractResultsFromJson() with structure validation
   
3. dashboard/src/data-parser.js
   - Enhanced loadData() with detailed console logging
   - Added staleness detection for reports
   - Added empty report (0 tests) warnings
   - Improved error messages with troubleshooting steps

4. DASHBOARD_REFRESH_GUIDE.md
   - Added "0 Tests" troubleshooting section
   - Added Playwright config fix instructions
   - Added diagnostic tool usage
   - Updated Summary section with new tools

FILES CREATED:
--------------
1. scripts/debug-dashboard.js (executable)
   - Complete diagnostic tool for dashboard issues
   - Checks dashboard files exist and are valid
   - Compares timestamps between project and dashboard
   - Validates Playwright configuration
   - Checks for test-results.json
   - Provides actionable recommendations

2. scripts/fix-dashboard-now.sh (executable)
   - Quick fix utility for dashboard refresh
   - Copies latest report to dashboard
   - Updates metadata
   - Opens dashboard with aggressive cache-busting
   - Provides troubleshooting steps if issues persist

VERIFICATION:
-------------
1. Ran Playwright tests in sample-project
2. Verified test-results.json created (39KB, 28 tests)
3. Debug tool confirms: "JSON reporter configured with outputFile"
4. Debug tool confirms: "test-results.json exists (38.4 KB), Contains 28 tests"

HOW TO USE NEW TOOLS:
---------------------
# Diagnose dashboard issues
node scripts/debug-dashboard.js [project-path]

# Force fix dashboard
./scripts/fix-dashboard-now.sh [project-path]

# Standard refresh
./refresh-dashboard.sh

PLAYWRIGHT CONFIG REQUIREMENT:
------------------------------
All projects using TestBot MUST have:
  reporter: [['json', { outputFile: 'test-results.json' }]]

Without this, the dashboard will show 0 tests even when tests pass.

================================================================================
Update: 2026-01-28 17:00 - CORS Fix for file:// Protocol
================================================================================

SUMMARY:
--------
Fixed CORS errors that prevented the dashboard from loading report data when
opened via file:// protocol. Browsers block fetch() requests from file:// URLs.

ROOT CAUSE:
-----------
When dashboard is opened via file:// protocol:
  - Browser blocks fetch('report.json') due to CORS policy
  - Dashboard falls back to mock data (21 tests, 100% pass rate)
  - Users see demo data instead of real test results

SOLUTION:
---------
Embed report data directly into HTML via a JavaScript file that sets a
global variable. This bypasses fetch() entirely for file:// protocol.

FILES MODIFIED:
---------------
1. testbot-mcp/src/dashboard-launcher.js
   - Now creates embedded-report.js with report data
   - Report data stored in window.__TESTBOT_EMBEDDED_REPORT__
   
2. dashboard/public/index.html
   - Added script tag to load embedded-report.js
   - Falls back gracefully if file doesn't exist
   
3. dashboard/src/data-parser.js
   - Checks for embedded data (window.__TESTBOT_EMBEDDED_REPORT__) first
   - Falls back to fetch() if no embedded data (for HTTP server mode)
   - Better CORS-specific error messages
   
4. scripts/fix-dashboard-now.sh
   - Now generates embedded-report.js automatically

FILES CREATED:
--------------
1. dashboard/public/embedded-report.js (auto-generated)
   - Contains the report data as a JavaScript variable
   - Regenerated each time TestBot runs or fix script is used
   - Bypasses CORS restrictions for file:// protocol

HOW IT WORKS:
-------------
1. TestBot generates report.json (for HTTP servers)
2. TestBot creates embedded-report.js with same data
3. Dashboard loads embedded-report.js first (works with file://)
4. If embedded data exists, uses it directly
5. If no embedded data, tries fetch() (works with http://)
6. Falls back to mock data only if both fail

VERIFICATION:
-------------
- Dashboard now shows real data (63 tests, 84% pass rate)
- No more CORS errors in browser console
- Works with both file:// and http:// protocols


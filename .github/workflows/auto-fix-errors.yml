name: Auto Fix Deliberate Errors

on:
  workflow_dispatch:
    inputs:
      trigger_reason:
        description: 'Reason for triggering the fix'
        required: false
        default: 'Manual trigger'
  push:
    branches:
      - main
    paths:
      - 'website/app/controllers/**'

jobs:
  detect-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check for deliberate errors
        id: check_errors
        run: |
          echo "Checking for deliberate errors..."
          if grep -r "DELIBERATE_ERROR" website/app/controllers/ 2>/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found deliberate errors to fix"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No deliberate errors found"
          fi
      
      - name: Apply fixes
        if: steps.check_errors.outputs.found == 'true'
        run: |
          echo "Applying automated fixes..."
          node scripts/apply-all-fixes.js
      
      - name: Check for changes
        id: check_changes
        if: steps.check_errors.outputs.found == 'true'
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes to commit"
          fi
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: Auto-fix deliberate errors in codebase'
          committer: GitHub Actions <actions@github.com>
          author: GitHub Actions <actions@github.com>
          branch: auto-fix/deliberate-errors-${{ github.run_number }}
          delete-branch: true
          title: 'ü§ñ Auto-fix: Resolve deliberate errors'
          body: |
            ## Automated Error Fixes
            
            This PR was automatically generated by the error detection and fixing workflow.
            
            ### Changes Made:
            - Fixed missing navire data in HomeController
            - Consolidated duplicate button containers (if applicable)
            - Applied all available automated fixes
            
            ### Details:
            - **Workflow Run**: ${{ github.run_number }}
            - **Triggered by**: ${{ github.event_name }}
            - **Commit SHA**: ${{ github.sha }}
            
            ### Note:
            This is part of the POC demonstration. The AI was able to fix the deliberate error automatically.
            However, other complex errors may require manual intervention.
            
            ---
            *Generated by GitHub Actions workflow*
          labels: |
            automated
            bug-fix
            poc
          assignees: ${{ github.actor }}
      
      - name: Summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check_errors.outputs.found }}" == "true" ]]; then
            echo "‚úÖ Deliberate errors were found and fixed" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]]; then
              echo "‚úÖ Pull request created with fixes" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ÑπÔ∏è No changes needed (already fixed)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ÑπÔ∏è No deliberate errors found in the codebase" >> $GITHUB_STEP_SUMMARY
          fi

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testbot Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="../src/styles/dashboard.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <h1><i class="fas fa-chart-line"></i> Test Dashboard</h1>
                <div class="header-meta">
                    <span class="project-name" id="projectName">Test Project</span>
                    <span class="test-date" id="testDate">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Scope Tabs -->
    <section class="scope-tabs-section">
        <div class="container">
            <div class="scope-tabs" role="tablist">
                <button class="scope-tab active" data-scope="all" role="tab" aria-selected="true">
                    <i class="fas fa-layer-group"></i>
                    All Jira Tests
                    <span class="scope-count" id="scopeAllCount">0</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div class="container">
            <section class="kpi-section">
                <h2 class="section-title">Key Metrics</h2>
                <div class="kpi-grid">
                    <div class="kpi-card kpi-total">
                        <div class="kpi-icon">
                            <i class="fas fa-vial"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="totalTests">0</div>
                            <div class="kpi-label">Total Tests</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-passed">
                        <div class="kpi-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="passedTests">0</div>
                            <div class="kpi-label">Passed</div>
                            <div class="kpi-percentage" id="passedPercentage">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-failed">
                        <div class="kpi-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="failedTests">0</div>
                            <div class="kpi-label">Failed</div>
                            <div class="kpi-percentage" id="failedPercentage">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-skipped">
                        <div class="kpi-icon">
                            <i class="fas fa-forward"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="skippedTests">0</div>
                            <div class="kpi-label">Skipped</div>
                            <div class="kpi-percentage" id="skippedPercentage">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-timedout">
                        <div class="kpi-icon">
                            <i class="fas fa-hourglass-end"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="timedoutTests">0</div>
                            <div class="kpi-label">Timed Out</div>
                            <div class="kpi-percentage" id="timedoutPercentage">0%</div>
                        </div>
                    </div>
                    <div class="kpi-card kpi-rate">
                        <div class="kpi-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="passRate">0%</div>
                            <div class="kpi-label">Pass Rate</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="passRateBar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Duration Card -->
                    <div class="kpi-card kpi-duration">
                        <div class="kpi-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-value" id="totalDuration">0s</div>
                            <div class="kpi-label">Total Duration</div>
                            <div class="kpi-percentage" id="avgDuration">Avg: 0s</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI Analysis Summary Section -->
            <section class="ai-summary-section" id="aiSummarySection" style="display: none;">
                <div class="ai-summary-header">
                    <h2 class="section-title">
                        <i class="fas fa-robot"></i> AI Analysis Summary
                        <span class="ai-summary-badge" id="aiSummaryBadge">0 analyses</span>
                    </h2>
                    <div class="ai-summary-counter" id="aiSummaryCounter">1 / 10</div>
                </div>
                <div class="ai-summary-carousel">
                    <button class="carousel-nav carousel-nav-prev" id="aiCarouselPrev" aria-label="Previous analysis">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="ai-summary-carousel-container" id="aiSummaryCarousel">
                        <!-- AI analysis cards will be injected here -->
                    </div>
                    <button class="carousel-nav carousel-nav-next" id="aiCarouselNext" aria-label="Next analysis">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </section>

            <!-- Category Breakdown -->
            <section class="category-section">
                <h2 class="section-title">Suite Breakdown</h2>
                <div class="category-grid" id="categoryCards">
                    <!-- Category cards injected via reporter.js -->
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-section">
                <h2 class="section-title">Visualizations</h2>
                <div class="charts-grid">
                    <!-- Status Distribution Chart -->
                    <div class="chart-card">
                        <h3 class="chart-title">Test Status Distribution</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <!-- Suite Results Chart -->
                    <div class="chart-card">
                        <h3 class="chart-title">Results by Test Suite</h3>
                        <div class="chart-container">
                            <canvas id="suiteChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Test Results Section -->
            <section class="results-section">
                <div class="results-header">
                    <h2 class="section-title">Test Results</h2>
                    <div class="results-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Search tests...">
                        </div>
                        <div class="filter-group">
                            <button class="filter-btn active" data-filter="all">
                                All <span class="badge" id="filterAllCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="passed">
                                Passed <span class="badge badge-passed" id="filterPassedCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="failed">
                                Failed <span class="badge badge-failed" id="filterFailedCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="skipped">
                                Skipped <span class="badge badge-skipped" id="filterSkippedCount">0</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="results-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    Test Name <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="suite">
                                    Suite <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="jira">
                                    Jira Story <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="status">
                                    Status <i class="fas fa-sort"></i>
                                </th>
                                <th class="sortable" data-sort="duration">
                                    Duration <i class="fas fa-sort"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="no-results" id="noResults" style="display: none;">
                    <i class="fas fa-search"></i>
                    <p>No tests found matching your criteria.</p>
                </div>
            </section>

            <!-- Regression Comparison Section -->
            <section class="regression-comparison-section" id="regressionComparisonSection">
                <div class="section-header-with-toggle">
                    <h2 class="section-title">
                        <i class="fas fa-code-branch"></i> Comparison
                    </h2>
                    <button class="collapse-toggle-btn" id="regressionCollapseBtn" aria-expanded="false" aria-controls="regressionComparisonContent">
                        <i class="fas fa-chevron-up"></i>
                        <span class="toggle-text">Expand</span>
                    </button>
                </div>
                <div class="comparison-container collapsible-content collapsed" id="regressionComparisonContent">
                    <!-- Branch Cards -->
                    <div class="comparison-branches">
                        <div class="branch-card branch-baseline">
                            <div class="branch-card-header">
                                <i class="fas fa-check-circle"></i>
                                <span class="branch-name">Main Branch (Baseline)</span>
                            </div>
                            <div class="branch-stats">
                                <div class="branch-stat-item">
                                    <span class="stat-label">Pass Rate</span>
                                    <span class="stat-value" id="baselinePassRate">100%</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Total Tests</span>
                                    <span class="stat-value" id="baselineTotal">0</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Passed</span>
                                    <span class="stat-value stat-passed" id="baselinePassed">0</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Failed</span>
                                    <span class="stat-value stat-failed" id="baselineFailed">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="comparison-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>

                        <div class="branch-card branch-current">
                            <div class="branch-card-header">
                                <i class="fas fa-code-branch"></i>
                                <span class="branch-name">Current Branch</span>
                            </div>
                            <div class="branch-stats">
                                <div class="branch-stat-item">
                                    <span class="stat-label">Pass Rate</span>
                                    <span class="stat-value" id="currentPassRate">0%</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Total Tests</span>
                                    <span class="stat-value" id="currentTotal">0</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Passed</span>
                                    <span class="stat-value stat-passed" id="currentPassed">0</span>
                                </div>
                                <div class="branch-stat-item">
                                    <span class="stat-label">Failed</span>
                                    <span class="stat-value stat-failed" id="currentFailed">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Metrics -->
                    <div class="comparison-metrics">
                        <div class="comparison-metric-card metric-trend" id="trendCard">
                            <div class="metric-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="metric-content">
                                <span class="metric-label">Overall Trend</span>
                                <span class="metric-value" id="trendValue">-</span>
                                <span class="metric-change" id="trendChange">-</span>
                            </div>
                        </div>

                        <div class="comparison-metric-card metric-failures">
                            <div class="metric-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="metric-content">
                                <span class="metric-label">New Failures</span>
                                <span class="metric-value" id="newFailuresValue">0</span>
                                <span class="metric-subtitle">Tests that failed in current branch</span>
                            </div>
                        </div>

                        <div class="comparison-metric-card metric-difference">
                            <div class="metric-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="metric-content">
                                <span class="metric-label">Pass Rate Change</span>
                                <span class="metric-value" id="passRateDiff">0%</span>
                                <span class="metric-subtitle">Difference from baseline</span>
                            </div>
                        </div>
                    </div>

                    <!-- Visual Comparison Chart -->
                    <div class="comparison-chart-container">
                        <h3 class="comparison-chart-title">Overall Pass Rate Comparison</h3>
                        <div class="comparison-bars">
                            <div class="comparison-bar-item">
                                <span class="bar-label">Main Branch</span>
                                <div class="bar-wrapper">
                                    <div class="bar bar-baseline" style="width: 100%">
                                        <span class="bar-value">100%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="comparison-bar-item">
                                <span class="bar-label">Current Branch</span>
                                <div class="bar-wrapper">
                                    <div class="bar bar-current" id="currentBar" style="width: 0%">
                                        <span class="bar-value" id="currentBarValue">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suite-wise Comparison -->
                    <div class="suite-comparison-container">
                        <h3 class="suite-comparison-title">
                            <i class="fas fa-layer-group"></i> Suite-wise Pass Rate Comparison
                        </h3>
                        <div class="suite-comparison-table-wrapper">
                            <table class="suite-comparison-table" id="suiteComparisonTable">
                                <thead>
                                    <tr>
                                        <th>Suite Name</th>
                                        <th>Main Branch</th>
                                        <th>Current Branch</th>
                                        <th>Difference</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="suiteComparisonTableBody">
                                    <!-- Suite comparison rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="dashboard-footer">
                <div class="footer-links">
                    <a href="../../testbot-reports/playwright-report/index.html" class="footer-link" target="_blank" id="playwrightReportLink">
                        <i class="fas fa-file-alt"></i> View Full Playwright Report
                    </a>
                    <a href="#" class="footer-link" onclick="window.print(); return false;">
                        <i class="fas fa-print"></i> Print Report
                    </a>
                </div>
                <div class="footer-info">
                    <p>Generated by Custom Playwright Dashboard Reporter</p>
                </div>
            </footer>
        </div>
    </main>

    <!-- Test Detail Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Test Details</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Artifact Viewer Modal -->
    <div class="modal" id="artifactModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="artifactModalTitle">Artifact Viewer</h3>
                <button class="modal-close" onclick="closeArtifactModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="artifactModalBody">
                <!-- Artifact content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Embedded report data (generated by TestBot to bypass CORS with file:// protocol) -->
    <script src="embedded-report.js?v=2" onerror="console.log('No embedded report found, will try fetch')"></script>
    <script src="../src/data-parser.js?v=3"></script>
    <script src="../src/reporter.js?v=3"></script>
    
    <!-- Auto-reload notification -->
    <script>
        // Check if report was just updated
        const urlParams = new URLSearchParams(window.location.search);
        const timestamp = urlParams.get('t');
        if (timestamp) {
            const reportTime = new Date(parseInt(timestamp));
            const now = new Date();
            const secondsAgo = Math.floor((now - reportTime) / 1000);
            
            if (secondsAgo < 10) {
                // Show toast notification
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'notification notification-success show';
                    notification.innerHTML = '<i class="fas fa-check-circle"></i><span>Dashboard refreshed with latest test results!</span>';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }, 500);
            }
        }
        
        // Prevent caching
        if (performance.navigation.type === 2) {
            // Page was accessed by navigating into the history
            location.reload(true);
        }
        
        // Check if Playwright report exists
        function checkPlaywrightReport() {
            const link = document.getElementById('playwrightReportLink');
            if (!link) return;
            
            // Try to fetch the report to see if it exists
            fetch('../../testbot-reports/playwright-report/index.html', { method: 'HEAD' })
                .then(response => {
                    if (!response.ok) {
                        // Report doesn't exist, disable the link
                        link.style.opacity = '0.5';
                        link.style.cursor = 'not-allowed';
                        link.title = 'Playwright HTML report not yet generated. Run tests to generate it.';
                        link.onclick = function(e) {
                            e.preventDefault();
                            alert('Playwright HTML report not yet generated. Run tests with the HTML reporter enabled to generate it.');
                            return false;
                        };
                    } else {
                        link.title = 'Open full Playwright HTML report in a new tab';
                    }
                })
                .catch(() => {
                    // Fetch failed, likely file:// protocol or report doesn't exist
                    link.title = 'Click to view full Playwright HTML report';
                });
        }
        
        // Check report availability after page loads
        setTimeout(checkPlaywrightReport, 500);
    </script>
</body>
</html>
